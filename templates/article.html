<!-- article.html -->
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script>
			tailwind.config = { darkMode: 'class' };
		</script>
		<script src="https://cdn.tailwindcss.com"></script>

		<!-- SEO and Social Media Meta Tags for Articles -->
		{% set page_title = article.title + " - Ollayor's Blog" %} {% set page_description = article.get_summary(160) %} {%
		set page_type = "article" %} {% set page_image = first_image if first_image else url_for('static',
		filename='myself-social.png', _external=True) %} {% set article_date = article.date_published.isoformat() if
		article.date_published else "" %} {% set article_modified = article.date_updated.isoformat() if article.date_updated
		else "" %} {% include 'seo_meta.html' %}

		<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
		<link
			href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<!-- Enhanced blog styling -->
		<link rel="stylesheet" href="{{ url_for('static', filename='blog-styles.css') }}" />
		{% include 'analytics.html' %}

		<!-- Syntax highlighting runtime (no theme CSS; we style via blog-styles.css) -->
		<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	</head>

	<body class="font-inter bg-gray-50 dark:bg-gray-900 min-h-screen flex flex-col">
		<!-- Reading progress indicator -->
		<div id="reading-progress" class="fixed top-0 left-0 w-full h-1 bg-gray-200 dark:bg-gray-700 z-50">
			<div
				class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-150 ease-out"
				style="width: 0%"
			></div>
		</div>
		{% include 'header.html' %}

		<main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
			{% if article %}
			<article class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden">
				<header class="p-8 border-b border-gray-100 dark:border-gray-700">
					<h1
						class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-4"
						style="font-family: 'Geist Mono', monospace"
					>
						{{ article.title }}
					</h1>
					<!-- Enhanced article metadata -->
					<div class="flex flex-wrap items-center gap-6 text-sm text-gray-600 dark:text-gray-400 mt-4">
						<div class="flex items-center gap-2">
							<i class="far fa-calendar-alt text-blue-500"></i>
							<span>{{ article.date_published.strftime('%d %B, %Y') }}</span>
						</div>
						<div class="flex items-center gap-2">
							<i class="far fa-clock text-green-500"></i>
							<span>{{ article.get_reading_time() }} min read</span>
						</div>
						<div class="flex items-center gap-2">
							<i class="far fa-eye text-purple-500"></i>
							<span>{{ view_count }} view{{ 's' if view_count != 1 else '' }}</span>
						</div>
					</div>
				</header>

				<section class="blog-content p-8">{{ article.content | safe }}</section>
			</article>
			{% else %}
			<div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-sm p-8 text-center">
				<p class="text-gray-600 dark:text-gray-200" style="font-family: 'JetBrains Mono', monospace">
					Article not found or not published yet.
				</p>
			</div>
			{% endif %}
		</main>

		{% include 'footer.html' %}

		<script>
			// Add copy buttons to code blocks inside article content
			document.addEventListener('DOMContentLoaded', () => {
				const container = document.querySelector('.blog-content');
				if (!container) return;

				// Reading progress indicator
				const progressBar = document.querySelector('#reading-progress div');
				if (progressBar) {
					function updateProgress() {
						const article = document.querySelector('article');
						if (!article) return;

						const articleTop = article.offsetTop;
						const articleHeight = article.offsetHeight;
						const scrollTop = window.pageYOffset;
						const windowHeight = window.innerHeight;

						const articleStart = articleTop - windowHeight / 3;
						const articleEnd = articleTop + articleHeight - windowHeight / 3;

						let progress = 0;
						if (scrollTop > articleStart) {
							progress = Math.min(100, ((scrollTop - articleStart) / (articleEnd - articleStart)) * 100);
						}

						progressBar.style.width = progress + '%';
					}

					window.addEventListener('scroll', updateProgress);
					updateProgress(); // Initial call
				}

				// Backfill missing alt/title on content images for accessibility/SEO
				const imgs = container.querySelectorAll('img');
				imgs.forEach((img) => {
					const fallback = '{{ article.title|e }}';
					if (!img.getAttribute('alt') || img.getAttribute('alt').trim() === '') {
						img.setAttribute('alt', fallback);
					}
					if (!img.getAttribute('title') || img.getAttribute('title').trim() === '') {
						img.setAttribute('title', fallback);
					}
				});
				const blocks = container.querySelectorAll('pre');
				blocks.forEach((pre) => {
					// Avoid duplicates
					if (pre.querySelector('.copy-btn')) return;
					const btn = document.createElement('button');
					btn.className = 'copy-btn';
					btn.type = 'button';
					btn.textContent = 'Copy';
					btn.addEventListener('click', async () => {
						const code = pre.querySelector('code');
						const text = code ? code.innerText : pre.innerText;
						try {
							await navigator.clipboard.writeText(text);
							btn.textContent = 'Copied!';
							btn.classList.add('copied');
							setTimeout(() => {
								btn.textContent = 'Copy';
								btn.classList.remove('copied');
							}, 1500);
						} catch (e) {
							btn.textContent = 'Failed';
							setTimeout(() => (btn.textContent = 'Copy'), 1500);
						}
					});
					pre.appendChild(btn);
				});

				// Initialize highlight.js if available and add a small language badge like ChatGPT
				try {
					if (window.hljs && typeof window.hljs.highlightAll === 'function') {
						window.hljs.highlightAll();
					}
				} catch (_) {}

				// Add language badges to code blocks
				blocks.forEach((pre) => {
					const code = pre.querySelector('code');
					if (!code) return;
					// Detect language from class names like language-js, lang-python, or hljs language
					const classes = (code.className || '').split(/\s+/);
					let lang = classes
						.map((c) => {
							if (c.startsWith('language-')) return c.replace('language-', '');
							if (c.startsWith('lang-')) return c.replace('lang-', '');
							return null;
						})
						.filter(Boolean)[0];
					// Some markdown renderers add classes like "python" directly
					if (!lang) {
						const simpleLang = classes.find((c) =>
							/^(bash|sh|zsh|shell|json|yaml|yml|toml|ini|js|ts|tsx|jsx|javascript|typescript|python|py|go|rust|rs|java|kotlin|swift|c|cpp|cs|php|ruby|rb|sql|html|css|scss|sass|md|markdown)$/.test(
								c,
							),
						);
						lang = simpleLang || '';
					}
					if (!lang) return;
					// Avoid duplicate badges
					if (pre.querySelector('.lang-badge')) return;
					const badge = document.createElement('span');
					badge.className = 'lang-badge';
					badge.textContent = lang.toUpperCase();
					pre.appendChild(badge);
				});
			});
		</script>

		{% if article %}
		<!-- Buy Me a Coffee Widget: only on article pages -->
		<script
			data-name="BMC-Widget"
			data-cfasync="false"
			src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js"
			data-id="ollayor"
			data-description="Support me on Buy me a coffee!"
			data-message="Tip me a coffee â€” thank you!"
			data-color="#5F7FFF"
			data-position="Right"
			data-x_margin="15"
			data-y_margin="15"
		></script>
		{% endif %}
	</body>
</html>
