<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{ 'Edit Article' if article else 'Publish New Article' }} - Ollayor's Blog</title>
		<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<script src="https://cdn.tailwindcss.com"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
		<!-- Enhanced blog styling for editor preview -->
		<link rel="stylesheet" href="{{ url_for('static', filename='blog-styles.css') }}" />
		{% include 'analytics.html' %}
		<style>
			/* Modern editor styling */
			.editor-container {
				min-height: 400px;
				border-radius: 12px;
				overflow: hidden;
				position: relative;
			}

			.modern-editor {
				font-family: 'Geist Mono', monospace;
				font-size: 1.1rem;
				line-height: 1.7;
				outline: none;
				min-height: 400px;
				padding: 1.5rem;
				border: none;
				background: inherit;
				color: inherit;
			}

			.modern-editor:empty:before {
				content: 'Start writing your amazing article...';
				color: #9ca3af;
				font-style: italic;
			}

			.dark .modern-editor:empty:before {
				color: #6b7280;
			}

			/* Inline formatting toolbar */
			.format-toolbar {
				position: absolute;
				background: white;
				border: 1px solid #e5e7eb;
				border-radius: 8px;
				box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
				padding: 0.5rem;
				display: none;
				z-index: 1000;
				gap: 0.25rem;
			}

			.dark .format-toolbar {
				background: #374151;
				border-color: #4b5563;
			}

			.format-btn {
				padding: 0.5rem;
				border: none;
				background: transparent;
				border-radius: 4px;
				cursor: pointer;
				color: #374151;
				transition: background-color 0.2s;
			}

			.format-btn:hover {
				background: #f3f4f6;
			}

			.dark .format-btn {
				color: #d1d5db;
			}

			.dark .format-btn:hover {
				background: #4b5563;
			}

			.format-btn.active {
				background: #dbeafe;
				color: #1d4ed8;
			}

			.dark .format-btn.active {
				background: #1e3a8a;
				color: #93c5fd;
			}

			.preview-toggle {
				transition: all 0.3s ease;
			}

			.preview-mode .editor-section {
				display: none;
			}

			.preview-section {
				display: none;
			}

			.preview-mode .preview-section {
				display: block;
			}

			/* Enhanced content styling */
			.modern-editor h1, .modern-editor h2, .modern-editor h3, 
			.modern-editor h4, .modern-editor h5, .modern-editor h6 {
				font-weight: bold;
				margin: 1rem 0 0.5rem 0;
			}

			.modern-editor h1 { font-size: 2rem; }
			.modern-editor h2 { font-size: 1.5rem; }
			.modern-editor h3 { font-size: 1.25rem; }
			.modern-editor h4 { font-size: 1.125rem; }
			.modern-editor h5 { font-size: 1rem; }
			.modern-editor h6 { font-size: 0.875rem; }

			.modern-editor ul, .modern-editor ol {
				margin: 1rem 0;
				padding-left: 2rem;
			}

			.modern-editor ul {
				list-style-type: disc;
			}

			.modern-editor ol {
				list-style-type: decimal;
			}

			.modern-editor li {
				margin: 0.25rem 0;
			}

			.modern-editor a {
				color: #2563eb;
				text-decoration: underline;
			}

			.modern-editor strong {
				font-weight: bold;
			}

			.modern-editor em {
				font-style: italic;
			}

			.modern-editor u {
				text-decoration: underline;
			}

			.modern-editor p {
				margin: 1rem 0;
			}

			.modern-editor p:first-child {
				margin-top: 0;
			}

			.modern-editor p:last-child {
				margin-bottom: 0;
			}
		</style>
	</head>

	<body class="font-inter bg-gray-50 dark:bg-gray-900 min-h-screen">
		<!-- Enhanced Header -->
		<header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
				<div class="flex items-center justify-between">
					<h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100" style="font-family: 'Geist Mono', monospace">
						<i class="fas fa-pen-fancy mr-2 text-blue-600"></i>
						{{ 'Edit Article' if article else 'Publish New Article' }} <span class="text-sm text-blue-600">(Modern)</span>
					</h1>
					<div class="flex items-center space-x-4">
						<button
							type="button"
							id="preview-toggle"
							class="preview-toggle inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200"
							style="font-family: 'JetBrains Mono', monospace"
						>
							<i class="fas fa-eye mr-2"></i>
							<span id="preview-text">Preview</span>
						</button>
						<a
							href="{{ url_for('blog') }}"
							class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200"
							style="font-family: 'JetBrains Mono', monospace"
						>
							<i class="fas fa-arrow-left mr-2"></i>
							Back to Blog
						</a>
					</div>
				</div>
			</div>
		</header>

		<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
			<div id="form-container" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
				<form action="" method="POST" class="p-8">
					<!-- Title Input -->
					<div class="mb-6">
						<label
							for="title"
							class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
							style="font-family: 'JetBrains Mono', monospace"
						>
							Article Title
						</label>
						<input
							type="text"
							id="title"
							name="title"
							placeholder="Enter your article title..."
							required
							spellcheck="false"
							class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg text-xl font-bold bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
							style="font-family: 'Geist Mono', monospace"
							value="{{article.title if article else ''}}"
						/>
					</div>

					<!-- Article Metadata -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
						<div class="flex items-center">
							<input
								type="checkbox"
								id="is_published"
								name="is_published"
								class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
								{%
								if
								article
								and
								article.is_published
								%}checked{%
								endif
								%}
							/>
							<label
								for="is_published"
								class="ml-2 block text-sm text-gray-700 dark:text-gray-300"
								style="font-family: 'JetBrains Mono', monospace"
							>
								<i class="fas fa-globe mr-1"></i>
								<span id="publish-label">Publish immediately</span>
							</label>
						</div>
						<div class="text-sm text-gray-500 dark:text-gray-400" style="font-family: 'JetBrains Mono', monospace">
							<i class="fas fa-info-circle mr-1"></i>
							<span id="status-indicator">{{ 'Editing existing article' if article else 'Creating new article' }}</span>
						</div>
					</div>

					<input type="hidden" name="content" id="content" value="{{article.content if article else ''}}" />

					<!-- Editor Section -->
					<div id="editor-section" class="editor-section">
						<label
							class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
							style="font-family: 'JetBrains Mono', monospace"
						>
							Content
						</label>
						<div class="editor-container border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
							<div 
								id="modern-editor" 
								class="modern-editor text-gray-900 dark:text-gray-100"
								contenteditable="true"
								spellcheck="false"
							></div>
							
							<!-- Inline formatting toolbar -->
							<div id="format-toolbar" class="format-toolbar">
								<button type="button" class="format-btn" data-command="bold" title="Bold (Ctrl+B)">
									<i class="fas fa-bold"></i>
								</button>
								<button type="button" class="format-btn" data-command="italic" title="Italic (Ctrl+I)">
									<i class="fas fa-italic"></i>
								</button>
								<button type="button" class="format-btn" data-command="underline" title="Underline (Ctrl+U)">
									<i class="fas fa-underline"></i>
								</button>
								<div class="border-l border-gray-300 dark:border-gray-600 mx-1"></div>
								<button type="button" class="format-btn" data-command="formatBlock" data-value="h1" title="Heading 1">
									H1
								</button>
								<button type="button" class="format-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
									H2
								</button>
								<button type="button" class="format-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
									H3
								</button>
								<div class="border-l border-gray-300 dark:border-gray-600 mx-1"></div>
								<button type="button" class="format-btn" data-command="insertUnorderedList" title="Bullet List">
									<i class="fas fa-list-ul"></i>
								</button>
								<button type="button" class="format-btn" data-command="insertOrderedList" title="Numbered List">
									<i class="fas fa-list-ol"></i>
								</button>
								<div class="border-l border-gray-300 dark:border-gray-600 mx-1"></div>
								<button type="button" class="format-btn" data-command="createLink" title="Insert Link">
									<i class="fas fa-link"></i>
								</button>
							</div>
						</div>
					</div>

					<!-- Preview Section -->
					<div id="preview-section" class="preview-section">
						<label
							class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
							style="font-family: 'JetBrains Mono', monospace"
						>
							Preview
						</label>
						<div class="border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
							<div id="preview-content" class="blog-content bg-white dark:bg-gray-700 p-8 min-h-[400px]">
								<p class="text-gray-500 dark:text-gray-400 italic">Start writing to see preview...</p>
							</div>
						</div>
					</div>

					<!-- Action Buttons -->
					<div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
						<div class="text-sm text-gray-500 dark:text-gray-400" style="font-family: 'JetBrains Mono', monospace">
							<i class="fas fa-lightbulb mr-1"></i>
							Tip: Select text to see formatting options, use preview to see how your article will look
						</div>
						<div class="space-x-4">
							{% if article %}
							<button
								type="button"
								onclick="if(confirm('Are you sure you want to delete this article?')) { window.location.href='{{ url_for('delete_article', slug=article.slug) }}'; }"
								class="inline-flex items-center px-4 py-2 border border-red-300 text-red-700 dark:text-red-400 dark:border-red-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900 transition-colors duration-200"
								style="font-family: 'JetBrains Mono', monospace"
							>
								<i class="fas fa-trash mr-2"></i>
								Delete
							</button>
							{% endif %}
							<button
								type="submit"
								id="publish-button"
								class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-lg hover:shadow-xl transform hover:scale-105"
								style="font-family: 'JetBrains Mono', monospace"
							>
								<i class="fas fa-rocket mr-2"></i>
								{{ 'Update Article' if article else 'Publish Article' }}
							</button>
						</div>
					</div>
				</form>
			</div>
		</main>

		<!-- Modern editor JavaScript -->
		<script>
			class ModernEditor {
				constructor() {
					this.editor = document.getElementById('modern-editor');
					this.toolbar = document.getElementById('format-toolbar');
					this.titleInput = document.getElementById('title');
					this.contentInput = document.getElementById('content');
					this.previewContent = document.getElementById('preview-content');
					this.isPreviewMode = false;
					this.autoSaveTimeout = null;
					
					this.init();
				}

				init() {
					this.setupEventListeners();
					this.loadExistingContent();
					this.setupPublishControls();
					this.setupPreviewMode();
					this.setupAutoSave();
				}

				setupEventListeners() {
					// Selection change for toolbar positioning
					document.addEventListener('selectionchange', () => {
						this.handleSelectionChange();
					});

					// Editor events
					this.editor.addEventListener('input', () => {
						this.updatePreview();
						this.triggerAutoSave();
					});

					this.editor.addEventListener('keydown', (e) => {
						this.handleKeyboardShortcuts(e);
					});

					// Toolbar button events
					this.toolbar.addEventListener('click', (e) => {
						if (e.target.classList.contains('format-btn') || e.target.parentElement.classList.contains('format-btn')) {
							e.preventDefault();
							const btn = e.target.classList.contains('format-btn') ? e.target : e.target.parentElement;
							this.executeCommand(btn);
						}
					});

					// Prevent toolbar from losing focus
					this.toolbar.addEventListener('mousedown', (e) => {
						e.preventDefault();
					});
				}

				handleSelectionChange() {
					const selection = window.getSelection();
					if (selection.rangeCount === 0) {
						this.hideToolbar();
						return;
					}

					const range = selection.getRangeAt(0);
					if (selection.isCollapsed || !this.editor.contains(range.commonAncestorContainer)) {
						this.hideToolbar();
						return;
					}

					this.showToolbar(range);
					this.updateToolbarState();
				}

				showToolbar(range) {
					const rect = range.getBoundingClientRect();
					const editorRect = this.editor.getBoundingClientRect();
					
					const left = Math.max(0, rect.left + (rect.width / 2) - (this.toolbar.offsetWidth / 2));
					const top = rect.top - this.toolbar.offsetHeight - 10;

					this.toolbar.style.left = `${left}px`;
					this.toolbar.style.top = `${top}px`;
					this.toolbar.style.display = 'flex';
				}

				hideToolbar() {
					this.toolbar.style.display = 'none';
				}

				updateToolbarState() {
					const buttons = this.toolbar.querySelectorAll('.format-btn');
					buttons.forEach(btn => {
						const command = btn.dataset.command;
						const isActive = document.queryCommandState(command);
						btn.classList.toggle('active', isActive);
					});
				}

				executeCommand(button) {
					const command = button.dataset.command;
					const value = button.dataset.value;

					if (command === 'createLink') {
						const url = prompt('Enter link URL:', 'https://');
						if (url) {
							document.execCommand(command, false, url);
						}
					} else if (value) {
						document.execCommand(command, false, value);
					} else {
						document.execCommand(command, false, null);
					}

					this.editor.focus();
					this.updateToolbarState();
					this.updatePreview();
					this.triggerAutoSave();
				}

				handleKeyboardShortcuts(e) {
					if (e.ctrlKey || e.metaKey) {
						switch (e.key) {
							case 'b':
								e.preventDefault();
								document.execCommand('bold');
								break;
							case 'i':
								e.preventDefault();
								document.execCommand('italic');
								break;
							case 'u':
								e.preventDefault();
								document.execCommand('underline');
								break;
						}
						this.updatePreview();
						this.triggerAutoSave();
					}
				}

				updatePreview() {
					if (!this.isPreviewMode) return;

					const title = this.titleInput.value || 'Untitled Article';
					const content = this.editor.innerHTML;

					this.previewContent.innerHTML = `
						<header class="border-b border-gray-200 dark:border-gray-700 pb-6 mb-8">
							<h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4" style="font-family: 'Geist Mono', monospace">
								${title}
							</h1>
							<div class="article-meta">
								<div class="meta-item">
									<i class="far fa-calendar-alt mr-2"></i>
									${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
								</div>
								<div class="meta-item">
									<i class="far fa-clock mr-2"></i>
									${Math.ceil(content.replace(/<[^>]*>/g, '').split(' ').length / 225)} min read
								</div>
							</div>
						</header>
						<div class="blog-content">
							${content || '<p class="text-gray-500 dark:text-gray-400 italic">Start writing to see your content...</p>'}
						</div>
					`;
				}

				setupPreviewMode() {
					const previewToggle = document.getElementById('preview-toggle');
					const previewText = document.getElementById('preview-text');
					const formContainer = document.getElementById('form-container');

					previewToggle.addEventListener('click', () => {
						this.isPreviewMode = !this.isPreviewMode;

						if (this.isPreviewMode) {
							formContainer.classList.add('preview-mode');
							previewText.textContent = 'Edit';
							previewToggle.querySelector('i').className = 'fas fa-edit mr-2';
							this.updatePreview();
							this.hideToolbar();
						} else {
							formContainer.classList.remove('preview-mode');
							previewText.textContent = 'Preview';
							previewToggle.querySelector('i').className = 'fas fa-eye mr-2';
						}
					});

					// Update preview on title change
					this.titleInput.addEventListener('input', () => {
						if (this.isPreviewMode) {
							this.updatePreview();
						}
					});
				}

				setupPublishControls() {
					const publishCheckbox = document.getElementById('is_published');
					const publishButton = document.getElementById('publish-button');
					const statusIndicator = document.getElementById('status-indicator');
					const publishLabel = document.getElementById('publish-label');
					const isEditMode = {{ 'true' if article else 'false' }};

					function updatePublishState() {
						const isChecked = publishCheckbox.checked;

						if (isEditMode) {
							if (isChecked) {
								publishButton.innerHTML = '<i class="fas fa-rocket mr-2"></i>Update & Publish';
								statusIndicator.innerHTML = '<i class="fas fa-globe mr-1"></i>Will be published';
								publishLabel.textContent = 'Publish this article';
							} else {
								publishButton.innerHTML = '<i class="fas fa-save mr-2"></i>Save as Draft';
								statusIndicator.innerHTML = '<i class="fas fa-file-alt mr-1"></i>Will be saved as draft';
								publishLabel.textContent = 'Save as draft only';
							}
						} else {
							if (isChecked) {
								publishButton.innerHTML = '<i class="fas fa-rocket mr-2"></i>Publish Article';
								statusIndicator.innerHTML = '<i class="fas fa-globe mr-1"></i>Will be published immediately';
								publishLabel.textContent = 'Publish immediately';
							} else {
								publishButton.innerHTML = '<i class="fas fa-save mr-2"></i>Save as Draft';
								statusIndicator.innerHTML = '<i class="fas fa-file-alt mr-1"></i>Will be saved as draft';
								publishLabel.textContent = 'Save as draft only';
							}
						}
					}

					updatePublishState();
					publishCheckbox.addEventListener('change', updatePublishState);

					// Form submission
					document.querySelector('form').addEventListener('submit', (e) => {
						const publishButton = document.getElementById('publish-button');
						const originalText = publishButton.innerHTML;
						const isPublishing = publishCheckbox.checked;

						if (isPublishing) {
							publishButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Publishing...';
						} else {
							publishButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
						}
						publishButton.disabled = true;

						// Set the value of the hidden input to the HTML from the modern editor
						this.contentInput.value = this.editor.innerHTML;

						// Reset button state after a delay (in case of errors)
						setTimeout(() => {
							publishButton.innerHTML = originalText;
							publishButton.disabled = false;
						}, 5000);
					});
				}

				setupAutoSave() {
					const autoSave = () => {
						clearTimeout(this.autoSaveTimeout);
						this.autoSaveTimeout = setTimeout(() => {
							const content = this.editor.innerHTML;
							localStorage.setItem(
								'article_draft_modern',
								JSON.stringify({
									title: this.titleInput.value,
									content: content,
									timestamp: Date.now(),
								}),
							);
						}, 2000);
					};

					this.editor.addEventListener('input', autoSave);
					this.titleInput.addEventListener('input', autoSave);
				}

				loadExistingContent() {
					// Load existing content from server
					const existingContent = this.contentInput.value;
					if (existingContent) {
						this.editor.innerHTML = existingContent;
						return;
					}

					// Try to load draft from localStorage
					const savedDraft = localStorage.getItem('article_draft_modern');
					if (savedDraft) {
						const draft = JSON.parse(savedDraft);
						if (confirm('Found a saved draft. Would you like to restore it?')) {
							this.titleInput.value = draft.title || '';
							this.editor.innerHTML = draft.content || '';
						}
					}
				}

				triggerAutoSave() {
					// Trigger the auto-save functionality manually without causing input event
					clearTimeout(this.autoSaveTimeout);
					this.autoSaveTimeout = setTimeout(() => {
						const content = this.editor.innerHTML;
						localStorage.setItem(
							'article_draft_modern',
							JSON.stringify({
								title: this.titleInput.value,
								content: content,
								timestamp: Date.now(),
							}),
						);
					}, 2000);
				}
			}

			// Initialize the modern editor when DOM is ready
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', () => new ModernEditor());
			} else {
				new ModernEditor();
			}
		</script>
	</body>
</html>